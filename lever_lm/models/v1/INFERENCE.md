# V1 æ¨¡å‹æ¨ç†æŒ‡å—

## ğŸ“– æ¦‚è¿°

V1 æ¨ç†è„šæœ¬ç”¨äºä½¿ç”¨è®­ç»ƒå¥½çš„ Pointer Selector V1 æ¨¡å‹è¿›è¡ŒæŒ‡é’ˆé€‰æ‹©æ¨ç†ï¼Œå¹¶è¯„ä¼°é€‰æ‹©å‡†ç¡®ç‡ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¡®ä¿å·²è®­ç»ƒå¥½æ¨¡å‹

è®­ç»ƒå®Œæˆåï¼Œæ¨¡å‹æ£€æŸ¥ç‚¹ä¿å­˜åœ¨ï¼š
```
results/model_cpk/vqa/{é…ç½®åç§°}/last.pt
```

### 2. è¿è¡Œæ¨ç†

```bash
cd /mnt/share/yiyun/Projects/VLM/Lever-Plus/Lever-Plus-04
bash scripts/pointer_inference.sh
```

## ğŸ“‹ æ¨ç†æµç¨‹

### æ­¥éª¤ 1ï¼šåŠ è½½æ¨¡å‹
- ä»æ£€æŸ¥ç‚¹åŠ è½½è®­ç»ƒå¥½çš„ V1 æ¨¡å‹
- æ¨¡å‹è‡ªåŠ¨è®¾ç½®ä¸ºè¯„ä¼°æ¨¡å¼

### æ­¥éª¤ 2ï¼šåŠ è½½æ•°æ®
- Query embeddings (`query.pt`)
- Candidate embeddings (`candidates.pt`)
- Query æ•°æ®ï¼ˆåŒ…å«å€™é€‰æ± ä¿¡æ¯ï¼‰

### æ­¥éª¤ 3ï¼šæ‰¹é‡æ¨ç†
- å¯¹æ¯ä¸ª queryï¼š
  1. è·å–å…¶å€™é€‰æ± 
  2. èåˆå¤šæ¨¡æ€ embeddings
  3. ä½¿ç”¨ V1 æ¨¡å‹é€‰æ‹© ICDs
  4. æ˜ å°„å›å…¨å±€ ID

### æ­¥éª¤ 4ï¼šè¯„ä¼°
- ä¸æŸæœç´¢é‡‘æ ‡å¯¹æ¯”
- è®¡ç®— Step-wise å‡†ç¡®ç‡
- è®¡ç®—åºåˆ—å®Œå…¨åŒ¹é…ç‡

## ğŸ“Š è¾“å‡ºç»“æœ

### 1. æ¨ç†ç»“æœ
è·¯å¾„ï¼š`results/pointer_inference/vqa/{é…ç½®åç§°}_inference.json`

æ ¼å¼ï¼š
```json
{
  "query_id": {
    "predictions": [id1, id2, ...],
    "candidate_pool": [pool_ids],
    "scores": [score1, score2, ...]
  }
}
```

### 2. è¯„ä¼°æŒ‡æ ‡
è·¯å¾„ï¼š`results/pointer_inference/vqa/{é…ç½®åç§°}_metrics.json`

æŒ‡æ ‡ï¼š
- `total_queries`: æ€»æ¨ç†æ ·æœ¬æ•°
- `evaluated_queries`: å‚ä¸è¯„ä¼°çš„æ ·æœ¬æ•°
- `sequence_accuracy`: åºåˆ—å®Œå…¨åŒ¹é…ç‡
- `step_accuracy`: å„æ­¥å‡†ç¡®ç‡åˆ—è¡¨

## âš™ï¸ å‚æ•°é…ç½®

### ä¿®æ”¹ `scripts/pointer_inference.sh`

```bash
# åŸºç¡€å‚æ•°ï¼ˆéœ€ä¸è®­ç»ƒæ—¶ä¸€è‡´ï¼‰
--task vqa                      # ä»»åŠ¡ç±»å‹
--dataset vqav2                 # æ•°æ®é›†
--beam_model Qwen2.5-VL-3B      # æ¨¡å‹åç§°
--scoring_method gain           # è¯„åˆ†æ–¹æ³•
--sample_num 4949               # è®­ç»ƒæ ·æœ¬æ•°
--icds_num 32                   # å€™é€‰æ± å¤§å°
--icds_origin random_train      # å€™é€‰æ± æ¥æº
--shot_num 6                    # ICDæ•°é‡

# æ¨ç†å‚æ•°
--inference_num 1000            # æ¨ç†æ ·æœ¬æ•°é™åˆ¶ï¼ˆå¯é€‰ï¼‰
--device cuda:0                 # æ¨ç†è®¾å¤‡
```

## ğŸ“ˆ è¯„ä¼°ç¤ºä¾‹è¾“å‡º

```
ã€è¯„ä¼°æŒ‡æ ‡ã€‘
  è¯„ä¼°æ ·æœ¬æ•°: 1000
  åºåˆ—å®Œå…¨åŒ¹é…ç‡: 15.20%
  Step 1 å‡†ç¡®ç‡: 35.40%
  Step 2 å‡†ç¡®ç‡: 30.20%
  Step 3 å‡†ç¡®ç‡: 25.80%
  Step 4 å‡†ç¡®ç‡: 22.10%
  Step 5 å‡†ç¡®ç‡: 19.50%
  Step 6 å‡†ç¡®ç‡: 17.30%
```

## ğŸ”§ é«˜çº§ç”¨æ³•

### ä½¿ç”¨ç‰¹å®š Epoch çš„æ¨¡å‹

ä¿®æ”¹ `pointer_inference.py` ä¸­çš„æ£€æŸ¥ç‚¹è·¯å¾„ï¼š

```python
# é»˜è®¤ä½¿ç”¨ last.pt
checkpoint_path = os.path.join(checkpoint_dir, 'last.pt')

# æˆ–ä½¿ç”¨ç‰¹å®šepochï¼ˆæ¨è Epoch 2ï¼‰
checkpoint_path = os.path.join(checkpoint_dir, 'checkpoint_epoch_2.pt')
```

### é™åˆ¶æ¨ç†æ ·æœ¬æ•°

```bash
--inference_num 100  # åªæ¨ç†å‰100ä¸ªæ ·æœ¬ï¼ˆç”¨äºå¿«é€Ÿæµ‹è¯•ï¼‰
```

### æ‰¹é‡æ¨ç†å¤šä¸ªé…ç½®

åˆ›å»ºå¾ªç¯è„šæœ¬ï¼š

```bash
for origin in faissm random_train; do
  for shot in 2 4 6; do
    python workflows/pointer_inference.py \
      --icds_origin $origin \
      --shot_num $shot \
      ...
  done
done
```

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **å‚æ•°ä¸€è‡´æ€§**ï¼šæ¨ç†æ—¶çš„å‚æ•°éœ€è¦ä¸è®­ç»ƒæ—¶ä¿æŒä¸€è‡´ï¼Œä»¥ä¾¿æ‰¾åˆ°æ­£ç¡®çš„æ¨¡å‹æ£€æŸ¥ç‚¹

2. **æ•°æ®ä¾èµ–**ï¼š
   - éœ€è¦ `query.pt` å’Œ `candidates.pt`
   - éœ€è¦å€™é€‰æ± æ–‡ä»¶ï¼ˆ`query_*_icds.json`ï¼‰
   - éœ€è¦æŸæœç´¢é‡‘æ ‡æ–‡ä»¶ï¼ˆç”¨äºè¯„ä¼°ï¼‰

3. **æ˜¾å­˜å ç”¨**ï¼šæ¨ç†æ˜¯é€æ ·æœ¬è¿›è¡Œçš„ï¼Œæ˜¾å­˜å ç”¨å¾ˆå°

4. **è¯„ä¼°å‡†ç¡®æ€§**ï¼š
   - Step 1 å‡†ç¡®ç‡é¢„æœŸï¼š30-40%ï¼ˆK=32 æ—¶ï¼‰
   - åºåˆ—å®Œå…¨åŒ¹é…ç‡é¢„æœŸï¼š10-20%ï¼ˆ6-shot æ—¶ï¼‰

## ğŸ¯ é¢„æœŸæ€§èƒ½

åŸºäº 128ç»´ V1 æ¨¡å‹ï¼ˆVal Loss 4.799ï¼‰ï¼š

| æŒ‡æ ‡ | é¢„æœŸå€¼ |
|-----|--------|
| Step 1 Top-1 | 35-40% |
| Step 1 Top-5 | 70-75% |
| åºåˆ—åŒ¹é…ç‡ | 10-15% |
| æ¨ç†é€Ÿåº¦ | ~100 samples/sec |

## ğŸ› æ•…éšœæ’é™¤

### é—®é¢˜ 1ï¼šæ‰¾ä¸åˆ°æ¨¡å‹æ£€æŸ¥ç‚¹

**è§£å†³**ï¼šæ£€æŸ¥æ¨¡å‹è·¯å¾„å’Œå‚æ•°æ˜¯å¦ä¸è®­ç»ƒæ—¶ä¸€è‡´

### é—®é¢˜ 2ï¼šæ‰¾ä¸åˆ°æ•°æ®æ–‡ä»¶

**è§£å†³**ï¼šç¡®ä¿ `query.pt`, `candidates.pt` å’Œå€™é€‰æ± æ–‡ä»¶å­˜åœ¨

### é—®é¢˜ 3ï¼šCUDA å†…å­˜ä¸è¶³

**è§£å†³**ï¼šé™ä½ `inference_num` æˆ–ä½¿ç”¨ CPUï¼ˆ`--device cpu`ï¼‰

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ¨¡å‹æ¶æ„è¯´æ˜](README.md)
- [è®­ç»ƒæŒ‡å—](../../scripts/pointer_train.sh)
- [æ•°æ®å‡†å¤‡æµç¨‹](../../README.md)





