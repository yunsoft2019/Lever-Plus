# V3 RL æ•°æ®ç”Ÿæˆå®ç°å®Œæˆæ€»ç»“

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ¸©åº¦é‡‡æ ·å’Œå€™é€‰ç”Ÿæˆ (`rl_data_generation.py`)
- âœ… `compute_step_logits()`: è®¡ç®—å•æ­¥ logitsï¼ˆé€‚é… PointerSelectorV2/V3ï¼‰
- âœ… `sample_pointer_with_temperature()`: æ¸©åº¦é‡‡æ ·å®ç°ï¼ˆæŒ‰ç…§å¼ºåŒ–å­¦ä¹ .md Â§3.2ï¼‰
- âœ… `generate_pointer_candidates_for_query()`: ç”Ÿæˆå€™é€‰åºåˆ—ï¼ˆbeam + æ¸©åº¦é‡‡æ · + éšæœºç»„åˆï¼‰

### 2. Correctness è®¡ç®— (`rl_data_generation.py`)
- âœ… `evaluate_pointer_candidate()`: Correctness è®¡ç®—æ¡†æ¶ï¼ˆæŒ‰ç…§å¼ºåŒ–å­¦ä¹ .md Â§3.3ï¼‰

### 3. Reward è®¡ç®—å·¥å…· (`reward_utils.py`)
- âœ… `compute_reward_for_candidate()`: ç»„åˆ reward è®¡ç®—ï¼ˆbeam_score + correctnessï¼ŒæŒ‰ç…§å¼ºåŒ–å­¦ä¹ .md Â§3.4ï¼‰

### 4. RL æ•°æ®ç”Ÿæˆè„šæœ¬ (`generate_rl_data.py`)
- âœ… `load_vqa_model()`: åŠ è½½ VQA æ¨¡å‹ï¼ˆä½¿ç”¨ `init_interface`ï¼‰
- âœ… `build_vqa_prompt_and_generate()`: æ„å»º VQA prompt å¹¶ç”Ÿæˆç­”æ¡ˆï¼ˆæŒ‰ç…§ `icl_inference.py` çš„æ–¹å¼ï¼‰
- âœ… `compute_vqa_accuracy()`: è®¡ç®— VQA å‡†ç¡®ç‡ï¼ˆæ”¯æŒæ–‡ä»¶æ–¹å¼å’Œç®€å•åŒ¹é…æ–¹å¼ï¼‰
- âœ… `generate_rl_data()`: å®Œæ•´çš„ RL æ•°æ®ç”Ÿæˆæµç¨‹
- âœ… `main()`: å‘½ä»¤è¡Œæ¥å£ï¼Œæ”¯æŒå®Œæ•´çš„æ•°æ®ç”Ÿæˆæµç¨‹

## ğŸ“‹ æ•°æ®æ ¼å¼

æ–°çš„ RL æ•°æ®æ ¼å¼ï¼ˆæŒ‰ç…§å¼ºåŒ–å­¦ä¹ .md Â§2.1ï¼‰ï¼š

```json
{
  "query_id": {
    "pointer_candidates": [
      {
        "pointer": [7, 22],
        "gen_method": "beam",
        "beam_rank": 0,
        "beam_score": 2.13,
        "logprob_score": -1.56,
        "temperature": null,
        "vqa_pred_answer": "a book",
        "vqa_correct": 1,
        "vqa_acc_score": 1.0
      },
      {
        "pointer": [5, 18],
        "gen_method": "sample",
        "beam_rank": null,
        "beam_score": null,
        "logprob_score": -2.03,
        "temperature": 1.0,
        "vqa_pred_answer": "a notebook",
        "vqa_correct": 1,
        "vqa_acc_score": 0.9
      }
    ]
  }
}
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ç”¨æ³•

```bash
python -m lever_lm.models.v3.generate_rl_data \
    --sft_ckpt results/okvqa/model_cpk/v2/xxx.ckpt \
    --beam_data results/okvqa/generated_data/beam_RandSampler.json \
    --output_path results/okvqa/generated_data/rl_data_RandSampler.json \
    --query_emb results/okvqa/cache/query_embeddings.pt \
    --cand_emb results/okvqa/cache/candidate_embeddings.pt \
    --vqa_model qwen2.5_vl_3B \
    --dataset okvqa_local \
    --num_beams 5 \
    --temps 1.0 1.3 \
    --num_samples_per_temp 2 \
    --num_random 1 \
    --device cuda:0
```

### ä½¿ç”¨é…ç½®æ–‡ä»¶

```bash
python -m lever_lm.models.v3.generate_rl_data \
    --sft_ckpt results/okvqa/model_cpk/v2/xxx.ckpt \
    --beam_data results/okvqa/generated_data/beam_RandSampler.json \
    --output_path results/okvqa/generated_data/rl_data_RandSampler.json \
    --query_emb results/okvqa/cache/query_embeddings.pt \
    --cand_emb results/okvqa/cache/candidate_embeddings.pt \
    --config configs/inference.yaml \
    --val_ques_path data/okvqa/val_questions.json \
    --val_ann_path data/okvqa/val_annotations.json \
    --device cuda:0
```

## ğŸ”‘ å…³é”®æ”¹è¿›ç‚¹

1. **æ•°æ®å¤šæ ·æ€§**ï¼š
   - Beam search: 3-5 æ¡é«˜è´¨é‡æ ·æœ¬
   - æ¸©åº¦é‡‡æ ·: Ï„=1.0 å’Œ Ï„=1.3ï¼Œæ¯ä¸ªæ¸©åº¦ 2-3 æ¡
   - éšæœºç»„åˆ: 1-2 æ¡ï¼ˆå¯é€‰ï¼‰
   - é¿å…"åªæ˜¯æŠŠ beam å†å­¦ä¸€é"

2. **ç«¯åˆ°ç«¯ä¿¡å·**ï¼š
   - ä½¿ç”¨ correctness ä½œä¸º reward
   - ç›´æ¥ä¼˜åŒ– VQA å‡†ç¡®ç‡
   - æ”¯æŒæ–‡ä»¶æ–¹å¼å’Œç®€å•åŒ¹é…æ–¹å¼è®¡ç®—å‡†ç¡®ç‡

3. **æ¢ç´¢èƒ½åŠ›**ï¼š
   - æ¸©åº¦é‡‡æ ·å¸®åŠ©å‘ç°é«˜è´¨é‡ä½†æ¦‚ç‡ä½çš„ç»„åˆ
   - éšæœºç»„åˆæä¾›è´Ÿæ ·æœ¬ä¸æ‹“å±•æ”¯æŒåŸŸ

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **è®¡ç®—æˆæœ¬**ï¼š
   - å¯¹æ¯ä¸ª pointer è°ƒç”¨ VQA æ¨¡å‹ï¼Œè®¡ç®—æˆæœ¬è¾ƒé«˜
   - å»ºè®®ä½¿ç”¨ GPU åŠ é€Ÿ
   - å¯ä»¥è€ƒè™‘æ‰¹é‡å¤„ç†æˆ–ç¼“å­˜ç»“æœ

2. **æ•°æ®è´¨é‡**ï¼š
   - å¦‚æœæä¾›äº† `val_ques_path` å’Œ `val_ann_path`ï¼Œä½¿ç”¨æ ‡å‡† VQAv2 è¯„ä¼°æ–¹å¼
   - å¦åˆ™ä½¿ç”¨ç®€å•åŒ¹é…æ–¹å¼ï¼ˆç²¾ç¡®åŒ¹é… + éƒ¨åˆ†åŒ¹é…ï¼‰

3. **Reward è®¾è®¡**ï¼š
   - ä½¿ç”¨ `compute_reward_for_candidate()` è®¡ç®—ç»„åˆ reward
   - å¯ä»¥æ ¹æ®å®é™…æ•ˆæœè°ƒæ•´ `alpha` å’Œ `beta` æƒé‡

## ğŸ”„ ä¸‹ä¸€æ­¥å·¥ä½œ

1. **æ›´æ–° `dataset_v3.py`**ï¼š
   - æ”¯æŒæ–°çš„æ•°æ®æ ¼å¼ï¼ˆåŒ…å« `vqa_correct` å’Œ `vqa_acc_score`ï¼‰
   - ä½¿ç”¨ `compute_reward_for_candidate()` è®¡ç®—ç»„åˆ reward

2. **æ›´æ–°è®­ç»ƒè„šæœ¬**ï¼š
   - åœ¨ `grpo_post_train.py` ä¸­ä½¿ç”¨æ–°çš„æ•°æ®æ ¼å¼
   - ä½¿ç”¨ç»„åˆ rewardï¼ˆbeam_score + correctnessï¼‰

3. **æµ‹è¯•å’ŒéªŒè¯**ï¼š
   - ç”Ÿæˆå°‘é‡æ•°æ®æµ‹è¯•æµç¨‹æ˜¯å¦æ­£ç¡®
   - éªŒè¯ correctness è®¡ç®—æ˜¯å¦å‡†ç¡®
   - éªŒè¯ reward è®¡ç®—æ˜¯å¦ç¬¦åˆé¢„æœŸ

## ğŸ“š å‚è€ƒæ–‡æ¡£

- `å¼ºåŒ–å­¦ä¹ .md`: å®Œæ•´çš„è®¾è®¡æ–‡æ¡£
- `lever_lm/models/v3/rl_data_generation.py`: æ ¸å¿ƒå®ç°
- `lever_lm/models/v3/generate_rl_data.py`: æ•°æ®ç”Ÿæˆè„šæœ¬
- `lever_lm/utils/reward_utils.py`: Reward è®¡ç®—å·¥å…·
- `icl_inference.py`: VQA æ¨ç†å‚è€ƒå®ç°
