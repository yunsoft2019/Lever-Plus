# 解冻投影层实验方案

## 问题分析

### 当前配置（冻结版本）

**冻结的层**：`input_proj`, `query_proj`, `cand_proj`（投影层）
**训练的层**：`cross_attn_layers`, `attn_norms`（pointer head）
**可训练参数**：50.1% (263,680 / 525,824)

**限制**：
- ❌ 无法调整如何理解 query 和候选的表示
- ✅ 只能调整如何组合这些表示来做选择

### 新配置（解冻版本）

**训练的层**：所有参数
- `input_proj`（输入投影层）
- `query_proj`（query 投影层）
- `cand_proj`（候选投影层）
- `cross_attn_layers`（交叉注意力层）
- `attn_norms`（注意力归一化层）

**可训练参数**：100% (525,824 / 525,824)

**优势**：
- ✅ 可以调整如何理解 query 和候选的表示
- ✅ 可以调整如何组合这些表示来做选择
- ✅ 更大的模型容量，可能学到更好的表示

## 实验设计

### 训练配置

| 参数 | 值 | 说明 |
|------|-----|------|
| **KL_BETA** | 0.15 | 目前最好的值 |
| **GRPO LR** | 5e-6 | 与冻结版本相同（或考虑更小如 2e-6） |
| **GRPO epochs** | 3 | 与冻结版本相同 |
| **数据文件** | `rl_data_k64_v3.json` | 统一数据 |
| **RCE checkpoint** | `kl012/rce_epoch5.pt` | 相同起点 |
| **冻结 backbone** | ❌ **否** | **关键差异** |

### 对比实验

| 配置 | 冻结 backbone | 可训练参数 | KL_BETA |
|------|--------------|-----------|---------|
| **基准** | ✅ 是 | 50.1% | 0.15 |
| **解冻版本** | ❌ 否 | 100% | 0.15 |

## 训练命令

### 解冻版本训练

```bash
bash scripts/train_grpo_kl015_unfrozen_from_rce.sh 5 0 3 kl012
```

参数说明：
- `5` - RCE epoch（从哪个 RCE epoch 开始）
- `0` - GPU ID
- `3` - GRPO epochs（训练 3 个 epochs）
- `kl012` - RCE checkpoint 所在目录

### 评估命令

```bash
# Epoch 1
bash scripts/eval_grpo_kl015_unfrozen.sh 1 0 200

# Epoch 2
bash scripts/eval_grpo_kl015_unfrozen.sh 2 0 200

# Epoch 3
bash scripts/eval_grpo_kl015_unfrozen.sh 3 0 200
```

## 预期结果对比

### 冻结版本（当前最佳）

| Epoch | Shot 1 | Shot 2 | Shot 3 | Shot 4 | 平均 |
|-------|--------|--------|--------|--------|------|
| **1** | **58.8%** | **56.6%** | 53.9% | 55.2% | **56.1%** |

### 解冻版本（待评估）

| Epoch | Shot 1 | Shot 2 | Shot 3 | Shot 4 | 平均 | vs 冻结版本 |
|-------|--------|--------|--------|--------|------|-------------|
| **1** | ? | ? | ? | ? | ? | ? |
| **2** | ? | ? | ? | ? | ? | ? |
| **3** | ? | ? | ? | ? | ? | ? |

## 可能的结果

### 情况 1：解冻版本更好 ✅

**原因**：
- 可以学习更好的 query 和候选表示
- 更大的模型容量允许更精细的调整

**建议**：
- 继续使用解冻版本
- 可能需要调整学习率或 epochs

### 情况 2：解冻版本更差 ⚠️

**原因**：
- 破坏了 RCE 阶段学到的良好表示
- 过拟合或训练不稳定

**建议**：
- 降低学习率（如 2e-6）
- 减少 epochs（如 1-2）
- 或者保持冻结版本

### 情况 3：结果相似 ➡️

**原因**：
- 投影层在 RCE 阶段已经学得很好
- GRPO 阶段主要需要调整选择策略

**建议**：
- 保持冻结版本（更稳定，训练更快）
- 或者根据训练稳定性选择

## 安全性保证 ✅

### 完全隔离的实验环境

1. **输出目录完全独立**：
   - 冻结版本：`v3_RandSampler_Qwen2_5-VL-3B-Instruct_kl015/`
   - 解冻版本：`v3_RandSampler_Qwen2_5-VL-3B-Instruct_kl015_unfrozen/`
   - ✅ **不会互相覆盖**

2. **RCE checkpoint 不会被修改**：
   - 路径：`v3_RandSampler_Qwen2_5-VL-3B-Instruct_kl012/rce_epoch5.pt`
   - ✅ **只读，训练过程不会修改它**
   - 两个版本都从同一个 RCE checkpoint 开始

3. **数据文件不会被修改**：
   - 路径：`results/okvqa/generated_data/rl_data_k64_v3.json`
   - ✅ **只读，训练过程只读取数据**

4. **随时可以恢复到冻结版本**：
   - 冻结版本的 checkpoint 仍然存在
   - 可以使用恢复脚本快速切换
   - 或者直接指定冻结版本的 checkpoint 路径

### 如何恢复到冻结版本

**方法 1：使用恢复脚本**
```bash
bash scripts/restore_to_frozen_kl015.sh
```

**方法 2：直接指定 checkpoint**
```bash
export LEVER_LM_CHECKPOINT_PATH=results/okvqa/model_cpk/v3_RandSampler_Qwen2_5-VL-3B-Instruct_kl015/grpo_epoch1_v2format.ckpt
bash scripts/inference.sh vqa okvqa_local 0 query_img_text_icd_img_text rand_sampler qwen2.5_vl_3B v3 200
```

**方法 3：查找现有的冻结版本 checkpoint**
```bash
find results/okvqa/model_cpk -name "*kl015*" -type d
ls -lh results/okvqa/model_cpk/v3_RandSampler_Qwen2_5-VL-3B-Instruct_kl015/grpo_epoch*.ckpt
```

## 风险与注意事项

### 风险

1. **破坏 RCE 成果**：解冻投影层可能破坏 RCE 阶段学到的良好表示
   - ✅ **不影响**：RCE checkpoint 不会被修改
   - ✅ **可恢复**：随时可以切换回冻结版本

2. **训练不稳定**：更多参数可能导致训练不稳定
   - ✅ **可调整**：可以降低学习率或减少 epochs

3. **过拟合**：更大的模型容量可能更容易过拟合
   - ✅ **可监控**：观察 Val Loss 是否上升

### 注意事项

1. **监控训练指标**：
   - KL 值是否正常
   - Train Loss 是否稳定下降
   - Val Loss 是否过拟合

2. **学习率调整**：
   - 如果训练不稳定，考虑降低学习率（如 2e-6）
   - 如果收敛太慢，考虑增加学习率

3. **Early Stopping**：
   - 如果 Val Loss 开始上升，提前停止训练

## 下一步

1. ✅ **已完成**：创建解冻版本的训练和评估脚本
2. ⏳ **待完成**：运行训练脚本
3. ⏳ **待完成**：评估并对比结果
4. ⏳ **待完成**：根据结果决定是否采用解冻版本

## 文件说明

- **训练脚本**：`scripts/train_grpo_kl015_unfrozen_from_rce.sh`
- **评估脚本**：`scripts/eval_grpo_kl015_unfrozen.sh`
- **输出目录**：`results/okvqa/model_cpk/v3_RandSampler_Qwen2_5-VL-3B-Instruct_kl015_unfrozen/`

