# ä»£ç ä¸æ–‡æ¡£ä¸€è‡´æ€§æ£€æŸ¥æŠ¥å‘Š

> å¯¹æ¯” `LeverPlus_v3_RL_next_steps_2025_12_10.md` æ–‡æ¡£è¦æ±‚ä¸å½“å‰ä»£ç å®ç°  
> æ£€æŸ¥æ—¶é—´ï¼š2025-12-10

---

## âœ… å·²å®Œå…¨å®ç°çš„æ”¹è¿›

### âœ… 3.1 æŠŠ RCE-only æ˜ç¡®å›ºåŒ–æˆ v3 é»˜è®¤è®­ç»ƒæ–¹å¼

**æ–‡æ¡£è¦æ±‚ï¼š**
- æ¨èé»˜è®¤é…ç½®ï¼š`--rce_epochs 5 --grpo_epochs 0`
- åœ¨ `GRPOTrainer.train()` é‡ŒåŠ ä¿æŠ¤ï¼šå¦‚æœ `grpo_epochs <= 0`ï¼Œæ‰“å°æç¤ºå¹¶ç›´æ¥è¿”å›

**å½“å‰å®ç°çŠ¶æ€ï¼š**
- âœ… `grpo_post_train.py` ç¬¬503è¡Œï¼š`--rce_epochs` é»˜è®¤å€¼æ˜¯ `5`
- âœ… `grpo_post_train.py` ç¬¬504è¡Œï¼š`--grpo_epochs` é»˜è®¤å€¼æ˜¯ `0`
- âœ… `grpo_post_train.py` ç¬¬425-430è¡Œï¼šæœ‰ `grpo_epochs <= 0` çš„ä¿æŠ¤é€»è¾‘

**ç»“è®ºï¼š** âœ… **å®Œå…¨å®ç°**

---

### âœ… 3.2 SFT checkpoint åŠ è½½æ—¶å¢åŠ ä¸€è‡´æ€§æ£€æŸ¥

**æ–‡æ¡£è¦æ±‚ï¼š**
- åœ¨ `generate_rl_data.py` å’Œ `grpo_post_train.py` ä¸­ï¼ŒåŠ è½½ checkpoint åæ£€æŸ¥ `missing` å’Œ `unexpected` å‚æ•°
- å¦‚æœç¼ºå¤±å‚æ•°è¿‡å¤šï¼ˆ>1000ï¼‰ï¼Œç›´æ¥ raise é”™è¯¯

**å½“å‰å®ç°çŠ¶æ€ï¼š**
- âœ… `generate_rl_data.py` ç¬¬88-114è¡Œï¼šæœ‰å®Œæ•´çš„ checkpoint åŠ è½½æ£€æŸ¥é€»è¾‘
- âœ… `grpo_post_train.py` ç¬¬356-382è¡Œï¼šæœ‰å®Œæ•´çš„ checkpoint åŠ è½½æ£€æŸ¥é€»è¾‘
- âœ… `grpo_post_train.py` ç¬¬758-785è¡Œï¼šæœ‰ v2 checkpoint åŠ è½½æ£€æŸ¥é€»è¾‘

**ç»“è®ºï¼š** âœ… **å®Œå…¨å®ç°**

---

### âœ… 3.4 RCE é˜¶æ®µä½¿ç”¨åŸå§‹ rewardï¼ˆå·²å®ç°å¼€å…³ï¼Œé»˜è®¤ä½¿ç”¨å½’ä¸€åŒ–åçš„ rewardï¼‰

**æ–‡æ¡£è¦æ±‚ï¼š**
- åœ¨ `GRPOTrainer` é‡Œå¢åŠ ä¸€ä¸ªé…ç½®å¼€å…³ `self.rce_use_raw_reward`
- åœ¨ `train_rce_epoch` ä¸­æ ¹æ®å¼€å…³å†³å®šä½¿ç”¨ `beam_rewards_raw` è¿˜æ˜¯ `beam_rewards`

**å½“å‰å®ç°çŠ¶æ€ï¼š**
- âœ… `grpo_post_train.py` ç¬¬84è¡Œï¼š`self.rce_use_raw_reward = False`ï¼ˆé»˜è®¤ä½¿ç”¨å½’ä¸€åŒ–åçš„ rewardï¼‰
- âœ… `grpo_post_train.py` ç¬¬177-180è¡Œï¼šæœ‰å¼€å…³é€»è¾‘ï¼Œæ ¹æ® `rce_use_raw_reward` é€‰æ‹©ä½¿ç”¨å“ªä¸ª reward
- âœ… `grpo_post_train.py` ç¬¬524-527è¡Œï¼šæœ‰ CLI å‚æ•° `--rce_use_raw_reward` å’Œ `--rce_use_normalized_reward`
- âœ… `grpo_post_train.py` ç¬¬806-814è¡Œï¼šæœ‰å®Œæ•´çš„å‚æ•°è®¾ç½®é€»è¾‘

**æ³¨æ„ï¼š** æˆ‘ä»¬ä¿®æ”¹äº†é»˜è®¤è¡Œä¸ºï¼Œä½¿ç”¨å½’ä¸€åŒ–åçš„ rewardï¼ˆä¸ `rce_epoch5.pt` ä¸€è‡´ï¼‰ï¼Œç¬¦åˆæ–‡æ¡£å»ºè®®ã€‚

**ç»“è®ºï¼š** âœ… **å®Œå…¨å®ç°**ï¼ˆä¸”é»˜è®¤è¡Œä¸ºå·²ä¼˜åŒ–ï¼‰

---

### âœ… 3.5.1 é™ä½é»˜è®¤å­¦ä¹ ç‡å’Œè®­ç»ƒè½®æ•°

**æ–‡æ¡£è¦æ±‚ï¼š**
- `grpo_epochs` é»˜è®¤å€¼æ”¹ä¸º 1~3ï¼ˆè€Œä¸æ˜¯ 8 æˆ– 25ï¼‰
- `grpo_lr` æ¯” RCE å†å°ä¸€æ¡£ï¼ˆä¾‹å¦‚ `3e-5` æˆ– `1e-5`ï¼‰

**å½“å‰å®ç°çŠ¶æ€ï¼š**
- âœ… `grpo_post_train.py` ç¬¬504è¡Œï¼š`--grpo_epochs` é»˜è®¤å€¼æ˜¯ `0`ï¼ˆRCE-only æ¨¡å¼ï¼‰
- âœ… `grpo_post_train.py` ç¬¬507è¡Œï¼š`--grpo_lr` é»˜è®¤å€¼æ˜¯ `1e-5`ï¼ˆæ¯” RCE çš„ `1e-4` å°ä¸€æ¡£ï¼‰

**ç»“è®ºï¼š** âœ… **å®Œå…¨å®ç°**

---

### âœ… 3.5.2 é™åˆ¶æ›´æ–°çš„å‚æ•°èŒƒå›´ï¼ˆå†»ç»“ backboneï¼‰

**æ–‡æ¡£è¦æ±‚ï¼š**
- åœ¨ `grpo_post_train.py` ä¸­å¢åŠ  `--freeze_backbone_in_grpo` å‚æ•°
- å¦‚æœå¼€å¯ï¼ŒGRPO æ—¶åªè®­ç»ƒ pointer headï¼Œå†»ç»“ backbone

**å½“å‰å®ç°çŠ¶æ€ï¼š**
- âœ… `grpo_post_train.py` ç¬¬89è¡Œï¼š`self.freeze_backbone_in_grpo = False`
- âœ… `grpo_post_train.py` ç¬¬529-530è¡Œï¼šæœ‰ CLI å‚æ•° `--freeze_backbone_in_grpo`
- âœ… `grpo_post_train.py` ç¬¬443-460è¡Œï¼šæœ‰å®Œæ•´çš„å†»ç»“é€»è¾‘ï¼ˆå†»ç»“ `input_proj`, `query_proj`, `cand_proj`ï¼‰
- âœ… `grpo_post_train.py` ç¬¬468-472è¡Œï¼šæ ¹æ®å†»ç»“çŠ¶æ€åˆ›å»º optimizer
- âœ… `grpo_post_train.py` ç¬¬817è¡Œï¼šåœ¨ main() ä¸­è®¾ç½®å‚æ•°

**ç»“è®ºï¼š** âœ… **å®Œå…¨å®ç°**

---

## âŒ æœªå®ç°çš„æ”¹è¿›

### âŒ 3.3 åœ¨ RL JSON ä¸­æ˜¾å¼æ ‡è®° reward è´¨é‡ï¼Œå¹¶å…è®¸è®­ç»ƒé˜¶æ®µè¿‡æ»¤ fallback æ ·æœ¬

#### âŒ 3.3.1 æ·»åŠ  `vqa_eval_mode` å­—æ®µ

**æ–‡æ¡£è¦æ±‚ï¼š**
- åœ¨ `generate_rl_data.py` ä¸­ï¼Œå¯¹æ¯ä¸ª pointer è®¡ç®—å®Œ correctness åï¼Œæ·»åŠ  `vqa_eval_mode` å­—æ®µ
- å€¼ä¸º `"file"`ï¼ˆå®˜æ–¹ VQA metricï¼‰æˆ– `"fallback"`ï¼ˆå­—ç¬¦ä¸²åŒ¹é…ï¼‰
- åœ¨ç»Ÿè®¡ä¿¡æ¯é‡Œæ‰“å°ä½¿ç”¨æƒ…å†µ

**å½“å‰å®ç°çŠ¶æ€ï¼š**
- âŒ `generate_rl_data.py` ç¬¬613-615è¡Œï¼šåªæ·»åŠ äº† `vqa_pred_answer`ã€`vqa_correct`ã€`vqa_acc_score`
- âŒ æ²¡æœ‰æ·»åŠ  `vqa_eval_mode` å­—æ®µ
- âš ï¸ æœ‰ç»Ÿè®¡ä¿¡æ¯ï¼ˆç¬¬606-610è¡Œï¼‰ï¼Œä½†æ²¡æœ‰æ‰“å°

**éœ€è¦ä¿®æ”¹ï¼š**
```python
# generate_rl_data.py ç¬¬613-615è¡Œ
c["vqa_pred_answer"] = pred_answer
c["vqa_correct"] = correct
c["vqa_acc_score"] = acc_score
c["vqa_eval_mode"] = "file" if used_file_metric else "fallback"  # æ–°å¢

# åœ¨ç»Ÿè®¡ä¿¡æ¯éƒ¨åˆ†ï¼ˆç¬¬628è¡Œä¹‹åï¼‰æ·»åŠ æ‰“å°
print(f"  - ä½¿ç”¨æ–‡ä»¶æ–¹å¼è®¡ç®—: {file_metric_count} ({file_metric_count/total_accuracy_computations*100:.1f}%)")
print(f"  - ä½¿ç”¨ fallback å­—ç¬¦ä¸²åŒ¹é…: {fallback_count} ({fallback_count/total_accuracy_computations*100:.1f}%)")
```

---

#### âŒ 3.3.2 åœ¨ Dataset ä¸­æ”¯æŒè·³è¿‡ fallback æ ·æœ¬

**æ–‡æ¡£è¦æ±‚ï¼š**
- åœ¨ `RLBeamDatasetWithEmbedding.__init__` ä¸­å¢åŠ  `skip_fallback_reward` å‚æ•°
- åœ¨éå† `pointer_candidates` æ—¶ï¼Œå¦‚æœ `skip_fallback_reward=True` ä¸” `vqa_eval_mode=="fallback"`ï¼Œåˆ™è·³è¿‡è¯¥æ ·æœ¬

**å½“å‰å®ç°çŠ¶æ€ï¼š**
- âŒ `dataset_v3.py` ç¬¬329-347è¡Œï¼š`__init__` æ–¹æ³•ä¸­æ²¡æœ‰ `skip_fallback_reward` å‚æ•°
- âŒ `dataset_v3.py` ç¬¬411-456è¡Œï¼šéå† `pointer_candidates` æ—¶æ²¡æœ‰è¿‡æ»¤ fallback æ ·æœ¬çš„é€»è¾‘

**éœ€è¦ä¿®æ”¹ï¼š**
```python
# dataset_v3.py ç¬¬329è¡Œï¼Œåœ¨ __init__ å‚æ•°ä¸­æ·»åŠ ï¼š
def __init__(
    ...,
    skip_fallback_reward: bool = False,  # æ–°å¢
):
    ...
    self.skip_fallback_reward = skip_fallback_reward  # æ–°å¢

# dataset_v3.py ç¬¬411è¡Œï¼Œåœ¨éå†æ—¶æ·»åŠ è¿‡æ»¤ï¼š
for c in pointer_candidates:
    # å¦‚æœè¦æ±‚è·³è¿‡ fallback æ ·æœ¬
    if self.skip_fallback_reward and c.get("vqa_eval_mode") == "fallback":
        continue  # æ–°å¢
    
    pointer = c["pointer"]
    ...
```

---

#### âŒ 3.3.3 åœ¨è®­ç»ƒè„šæœ¬ä¸­æš´éœ²å¼€å…³

**æ–‡æ¡£è¦æ±‚ï¼š**
- åœ¨ `grpo_post_train.py` çš„ argparse ä¸­å¢åŠ  `--skip_fallback_reward` å‚æ•°
- åœ¨æ„é€  dataset æ—¶ä¼ å…¥è¯¥å‚æ•°

**å½“å‰å®ç°çŠ¶æ€ï¼š**
- âŒ `grpo_post_train.py` argparse ä¸­æ²¡æœ‰ `--skip_fallback_reward` å‚æ•°
- âŒ éœ€è¦æ‰¾åˆ° dataset æ„é€ çš„ä½ç½®å¹¶ä¼ å…¥å‚æ•°

**éœ€è¦ä¿®æ”¹ï¼š**
```python
# grpo_post_train.py argparse ä¸­æ·»åŠ ï¼š
parser.add_argument(
    "--skip_fallback_reward",
    action="store_true",
    help="æ˜¯å¦è·³è¿‡ä½¿ç”¨ fallback æ–¹å¼è®¡ç®—çš„ RL æ ·æœ¬ï¼ˆæ¨èåœ¨ OKVQA ä¸Šæ‰“å¼€ï¼‰"
)

# åœ¨æ„é€  dataset æ—¶ä¼ å…¥ï¼ˆéœ€è¦æ‰¾åˆ° dataset æ„é€ çš„ä½ç½®ï¼‰
train_dataset = RLBeamDatasetWithEmbedding(
    ...,
    skip_fallback_reward=args.skip_fallback_reward,  # æ–°å¢
)
val_dataset = RLBeamDatasetWithEmbedding(
    ...,
    skip_fallback_reward=args.skip_fallback_reward,  # æ–°å¢
)
```

---

## ğŸ“Š å®ç°è¿›åº¦æ€»ç»“

| æ”¹è¿›é¡¹ | çŠ¶æ€ | ä¼˜å…ˆçº§ |
|--------|------|--------|
| 3.1 RCE-only é»˜è®¤é…ç½® | âœ… å®Œå…¨å®ç° | é«˜ |
| 3.2 Checkpoint åŠ è½½æ£€æŸ¥ | âœ… å®Œå…¨å®ç° | é«˜ |
| 3.3.1 æ·»åŠ  vqa_eval_mode | âŒ æœªå®ç° | é«˜ |
| 3.3.2 æ”¯æŒè·³è¿‡ fallback | âŒ æœªå®ç° | é«˜ |
| 3.3.3 æš´éœ²å¼€å…³ | âŒ æœªå®ç° | é«˜ |
| 3.4 RCE reward å¼€å…³ | âœ… å®Œå…¨å®ç° | ä¸­ |
| 3.5.1 GRPO è¶…å‚ | âœ… å®Œå…¨å®ç° | ä¸­ |
| 3.5.2 å†»ç»“ backbone | âœ… å®Œå…¨å®ç° | ä¸­ |

**æ€»ä½“è¿›åº¦ï¼š** 7/8 é¡¹å·²å®ç°ï¼ˆ87.5%ï¼‰

---

## ğŸ¯ ä¸‹ä¸€æ­¥å»ºè®®

### ç«‹å³å®ç°ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

**3.3 å®Œæ•´å®ç°ï¼š**
1. åœ¨ `generate_rl_data.py` ä¸­æ·»åŠ  `vqa_eval_mode` å­—æ®µ
2. åœ¨ `dataset_v3.py` ä¸­æ·»åŠ  `skip_fallback_reward` å‚æ•°å’Œè¿‡æ»¤é€»è¾‘
3. åœ¨ `grpo_post_train.py` ä¸­æ·»åŠ  `--skip_fallback_reward` å‚æ•°å¹¶ä¼ å…¥ dataset

**é¢„è®¡å·¥ä½œé‡ï¼š** 30-60 åˆ†é’Ÿ

**ä»·å€¼ï¼š**
- è®© RL è®­ç»ƒåªä¿¡ä»»ã€Œæ¥æºæ›´å¹²å‡€ã€çš„ rewardï¼ˆå®˜æ–¹ VQA metricï¼‰
- fallback æ ·æœ¬ä»ç„¶ä¿ç•™åœ¨ JSON é‡Œï¼Œå¦‚æœæœªæ¥è¦åšå¯¹æ¯”å®éªŒä¹Ÿæ–¹ä¾¿
- æé«˜è®­ç»ƒæ•°æ®çš„è´¨é‡

---

## ğŸ“ å¤‡æ³¨

1. **3.4 é»˜è®¤è¡Œä¸ºè°ƒæ•´ï¼š**
   - æ–‡æ¡£å»ºè®®ä¿ç•™å½“å‰ pipelineï¼ˆä½¿ç”¨å½’ä¸€åŒ– rewardï¼‰
   - æˆ‘ä»¬å·²å°†é»˜è®¤æ”¹ä¸ºä½¿ç”¨å½’ä¸€åŒ–åçš„ rewardï¼ˆä¸ `rce_epoch5.pt` ä¸€è‡´ï¼‰
   - è¿™ç¬¦åˆæ–‡æ¡£çš„æœ€ç»ˆå»ºè®®ï¼Œä¸”æ›´ç¬¦åˆæœ€ä½³å®è·µ

2. **3.1 é»˜è®¤é…ç½®ï¼š**
   - æ–‡æ¡£å»ºè®® `--rce_epochs 5 --grpo_epochs 0`
   - å½“å‰å®ç°å®Œå…¨ç¬¦åˆè¦æ±‚

3. **3.2 Checkpoint æ£€æŸ¥ï¼š**
   - æ–‡æ¡£è¦æ±‚æ£€æŸ¥ `missing` å’Œ `unexpected` å‚æ•°
   - å½“å‰å®ç°å·²åŒ…å«å®Œæ•´çš„æ£€æŸ¥é€»è¾‘ï¼ŒåŒ…æ‹¬é”™è¯¯æç¤ºå’Œå¼‚å¸¸å¤„ç†

---

**ç”Ÿæˆæ—¶é—´ï¼š** 2025-12-10  
**å¯¹æ¯”æ–‡æ¡£ï¼š** `LeverPlus_v3_RL_next_steps_2025_12_10.md`







