# Qwen分数转换（负数→正数）影响分析

## 一、转换内容

**转换前**：Qwen的束搜索分数是负数（如 -9.29e-08, -1.01e-07, ...）
**转换后**：取绝对值，变为正数（如 9.29e-08, 1.01e-07, ...）

## 二、对训练结果的影响

### 2.1 v0/v1/v2版本（监督学习）

**结论：无影响**

**原因**：
- 这些版本使用**监督学习（Supervised Learning）**
- 训练时只使用 `icd_seq`（标签序列），不使用 `icd_score`（分数）
- 从代码 `lever_lm/dataset_module/base_lever_lm_ds.py` 可以看到，`icd_score` 只是被读取和存储，但在损失计算中**完全没有使用**
- 训练目标是让模型预测出正确的序列，而不是学习分数

**验证**：
```python
# lever_lm/dataset_module/base_lever_lm_ds.py
icd_score_list = data["icd_score"]  # 只是读取，没有使用
for icd_seq, icd_score in zip(icd_seq_list, icd_score_list):
    # 不再过滤：if icd_score < self.threshold: continue
    # 分数完全没有参与训练
```

### 2.2 v3版本（强化学习）

**结论：可能有轻微影响，但影响很小**

**原因**：
- v3版本使用**强化学习（RCE + GRPO）**
- 分数作为 `rewards`（奖励）使用
- 但会进行**归一化处理**（zscore或minmax），归一化只关注相对大小关系，不关注绝对数值

**关键问题：相对大小关系是否改变？**

**原始Qwen分数（负数）**：
- Beam 1: -9.29e-08（最好，绝对值最小）
- Beam 2: -1.01e-07
- Beam 3: -1.07e-07
- Beam 4: -1.13e-07
- Beam 5: -1.18e-07（最差，绝对值最大）

**转换后（正数）**：
- Beam 1: 9.29e-08（数值最小）
- Beam 2: 1.01e-07
- Beam 3: 1.07e-07
- Beam 4: 1.13e-07
- Beam 5: 1.18e-07（数值最大）

**相对大小关系**：
- **原始**：Beam 1 > Beam 2 > Beam 3 > Beam 4 > Beam 5（负数，绝对值越小越好）
- **转换后**：Beam 1 < Beam 2 < Beam 3 < Beam 4 < Beam 5（正数，数值越大越好）

**影响分析**：
1. **相对大小关系反转了**：原本最好的Beam 1现在数值最小，最差的Beam 5现在数值最大
2. **但归一化会处理这个问题**：
   - zscore归一化：`(score - mean) / std`，会保持相对大小关系
   - minmax归一化：`(score - min) / (max - min)`，也会保持相对大小关系
3. **实际影响**：
   - 如果v3训练时使用的是**相对大小关系**（通过归一化），那么转换后虽然数值反转，但归一化后的相对关系仍然正确
   - 但需要确保归一化是在**每个query的5个beam内**进行的（组内归一化），而不是跨query归一化

**建议**：
- 如果v3已经训练完成，且使用的是原始负数分数，那么：
  - 需要重新训练v3模型，使用转换后的正数分数
  - 或者，在v3的训练代码中添加逻辑，对Qwen的分数取绝对值后再使用
- 如果v3还未训练，那么使用转换后的正数分数训练即可

## 三、对推理结果的影响

**结论：无影响**

**原因**：
- 推理时，模型只使用训练好的参数进行预测
- 推理不依赖数据文件中的分数
- 分数只在训练时使用（v3版本），推理时完全不需要

## 四、总结

| 版本 | 训练影响 | 推理影响 | 建议 |
|------|---------|---------|------|
| v0/v1/v2 | ✅ 无影响 | ✅ 无影响 | 无需重新训练 |
| v3（已训练） | ⚠️ 可能有影响 | ✅ 无影响 | 建议重新训练v3 |
| v3（未训练） | ✅ 无影响 | ✅ 无影响 | 使用转换后的分数训练 |

## 五、建议操作

1. **v0/v1/v2版本**：无需任何操作，转换不影响训练和推理
2. **v3版本**：
   - 如果已训练：建议重新训练v3模型，使用转换后的正数分数
   - 如果未训练：直接使用转换后的正数分数训练即可
3. **未来**：代码已修复（`utils.py` 第174-176行），未来生成的Qwen数据会自动使用正数分数



