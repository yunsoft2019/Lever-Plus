# KL_BETA 0.12 vs 0.15 最终对比报告

## 实验设置

- **KL_BETA=0.12**: Epoch 9
- **KL_BETA=0.15**: Epoch 42
- **测试样本数**: 800 (完整测试), 50 (索引对比测试)
- **其他参数**: 完全相同

## 关键发现

### 1. Checkpoint 权重确实不同

- **KL_BETA=0.12**: Epoch 8, KL loss=0.0076, Val loss=8.04
- **KL_BETA=0.15**: Epoch 41, KL loss=0.0085, Val loss=7.99
- **权重差异**:
  - 50.15% 的参数不同
  - 平均差异: 0.00047412
  - 最大差异: 0.00739133
  - 相对差异: 5-11% (关键参数)

### 2. 推理准确率完全相同

| Shot Num | KL_BETA=0.12 | KL_BETA=0.15 | 差异 |
|----------|--------------|--------------|------|
| 1        | 0.497        | 0.497        | 0.000 |
| 2        | 0.4823       | 0.4823       | 0.000 |
| 3        | 0.476        | 0.476        | 0.000 |
| 4        | 0.476        | 0.476        | 0.000 |

### 3. **范例索引选择 100% 相同** ⭐

**这是最关键的发現！**

- **测试样本数**: 50
- **完全相同的样本**: 50 (100%)
- **不同的样本**: 0 (0%)
- **相同率**: 100%

## 原因分析

### 为什么权重不同但结果相同？

1. **权重差异不足以改变离散选择**
   - 虽然权重有差异（平均差异 0.00047412），但这些差异太小
   - 范例选择是离散的 argmax 操作，小的权重差异不会改变最终选择
   - 只有当权重差异足够大，能够改变 logits 的排序时，才会影响选择结果

2. **模型已收敛到相似状态**
   - Epoch 8 和 Epoch 41 可能都已收敛到相似的表现
   - 虽然训练过程不同（KL_BETA 不同），但最终都学到了相似的范例选择策略

3. **KL_BETA 差异影响较小**
   - 0.12 和 0.15 的差异相对较小（25%）
   - 可能不足以在测试集上产生可观测的差异

4. **测试集敏感性**
   - 测试集可能对这类权重差异不够敏感
   - 需要更大的权重差异或更敏感的测试集才能观察到差异

## 结论

1. **两个 checkpoint 的权重确实不同**，验证了训练过程的不同
2. **但权重差异不足以改变范例选择结果**，导致推理准确率完全相同
3. **范例索引选择 100% 相同**，这直接解释了为什么准确率相同

## 建议

1. **使用相同的 epoch 进行对比**
   - 例如都用 epoch 9 或都用 epoch 42
   - 这样可以排除 epoch 差异的影响

2. **尝试更大的 KL_BETA 差异**
   - 例如 0.1 vs 0.2 或 0.05 vs 0.25
   - 更大的差异可能产生可观测的影响

3. **检查训练曲线**
   - 查看训练过程中 KL 散度和验证损失的变化
   - 确认两个模型是否真的学到了不同的策略

4. **使用更敏感的评估指标**
   - 除了准确率，还可以对比：
     - 选择的范例的相似度分布
     - 不同样本的范例选择多样性
     - 模型的不确定性

5. **检查随机性**
   - 虽然设置了随机种子，但可能还有其他随机因素
   - 多次运行确认结果的一致性

## 文件位置

- **KL_BETA=0.12 结果**: `results/okvqa/icl_inference/v0/Qwen2.5-VL-3B-Instruct_RandSampler_kl12_epoch9_metrics.json`
- **KL_BETA=0.15 结果**: `results/okvqa/icl_inference/v3/Qwen2.5-VL-3B-Instruct_RandSampler_kl15_epoch42_metrics.json`
- **索引对比结果**: `results/okvqa/icd_indices_comparison_shot1.json`

## 日期

2025-12-22




