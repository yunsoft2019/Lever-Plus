# æ”¹è¿› 3.3 å®ç°æ€»ç»“

> å®ç°æ—¶é—´ï¼š2025-12-10  
> åŸºäºï¼š`LeverPlus_v3_RL_next_steps_2025_12_10.md` ç¬¬ 3.3 èŠ‚

---

## âœ… 3.3.1 æ·»åŠ  `vqa_eval_mode` å­—æ®µ

### ä¿®æ”¹ä½ç½®

**æ–‡ä»¶ï¼š** `lever_lm/models/v3/generate_rl_data.py`

**ä¿®æ”¹å†…å®¹ï¼š**

1. **åœ¨æ·»åŠ  correctness ä¿¡æ¯æ—¶æ·»åŠ  `vqa_eval_mode` å­—æ®µ**ï¼ˆç¬¬616è¡Œï¼‰ï¼š
   ```python
   c["vqa_pred_answer"] = pred_answer
   c["vqa_correct"] = correct
   c["vqa_acc_score"] = acc_score
   c["vqa_eval_mode"] = "file" if used_file_metric else "fallback"  # æ–°å¢
   ```

2. **åœ¨å¼‚å¸¸å¤„ç†æ—¶ä¹Ÿæ·»åŠ  `vqa_eval_mode` å­—æ®µ**ï¼ˆç¬¬625è¡Œï¼‰ï¼š
   ```python
   c["vqa_pred_answer"] = ""
   c["vqa_correct"] = 0
   c["vqa_acc_score"] = 0.0
   c["vqa_eval_mode"] = "fallback"  # å¼‚å¸¸æƒ…å†µæ ‡è®°ä¸º fallback
   ```

**è¯´æ˜ï¼š**
- `vqa_eval_mode` å­—æ®µæ ‡è®° reward è´¨é‡æ¥æºï¼š
  - `"file"`ï¼šä½¿ç”¨å®˜æ–¹ VQA metric è®¡ç®—ï¼ˆæ›´å¯é ï¼‰
  - `"fallback"`ï¼šä½¿ç”¨å­—ç¬¦ä¸²åŒ¹é…è®¡ç®—ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
- ç»Ÿè®¡ä¿¡æ¯å·²åœ¨ç¬¬636-642è¡Œæ‰“å°ï¼Œæ— éœ€é¢å¤–ä¿®æ”¹

---

## âœ… 3.3.2 åœ¨ Dataset ä¸­æ”¯æŒè·³è¿‡ fallback æ ·æœ¬

### ä¿®æ”¹ä½ç½®

**æ–‡ä»¶ï¼š** `lever_lm/models/v3/dataset_v3.py`

**ä¿®æ”¹å†…å®¹ï¼š**

1. **åœ¨ `__init__` æ–¹æ³•ä¸­æ·»åŠ  `skip_fallback_reward` å‚æ•°**ï¼ˆç¬¬347è¡Œï¼‰ï¼š
   ```python
   skip_fallback_reward: bool = False  # 3.3.2: æ˜¯å¦è·³è¿‡ä½¿ç”¨ fallback æ–¹å¼è®¡ç®—çš„ RL æ ·æœ¬
   ```

2. **åœ¨æ–‡æ¡£å­—ç¬¦ä¸²ä¸­æ·»åŠ å‚æ•°è¯´æ˜**ï¼ˆç¬¬371è¡Œï¼‰ï¼š
   ```python
   skip_fallback_reward: æ˜¯å¦è·³è¿‡ä½¿ç”¨ fallback æ–¹å¼è®¡ç®—çš„ RL æ ·æœ¬ï¼ˆé»˜è®¤ Falseï¼Œæ¨èåœ¨ OKVQA ä¸Šæ‰“å¼€ï¼‰
   ```

3. **ä¿å­˜å‚æ•°**ï¼ˆç¬¬385è¡Œï¼‰ï¼š
   ```python
   self.skip_fallback_reward = skip_fallback_reward  # 3.3.2: ä¿å­˜å‚æ•°
   ```

4. **åœ¨éå† `pointer_candidates` æ—¶æ·»åŠ è¿‡æ»¤é€»è¾‘**ï¼ˆç¬¬415-417è¡Œï¼‰ï¼š
   ```python
   for c in pointer_candidates:
       # 3.3.2: å¦‚æœè¦æ±‚è·³è¿‡ fallback æ ·æœ¬
       if self.skip_fallback_reward and c.get("vqa_eval_mode") == "fallback":
           continue
       
       pointer = c["pointer"]
       ...
   ```

5. **æ·»åŠ æ£€æŸ¥ï¼šå¦‚æœè¿‡æ»¤åæ²¡æœ‰ä»»ä½•å€™é€‰ï¼Œè·³è¿‡è¿™ä¸ª query**ï¼ˆç¬¬468-470è¡Œï¼‰ï¼š
   ```python
   # 3.3.2: å¦‚æœè¿‡æ»¤åæ²¡æœ‰ä»»ä½•å€™é€‰ï¼Œè·³è¿‡è¿™ä¸ª query
   if len(beam_labels) == 0:
       continue
   ```

6. **åœ¨æ‰“å°ä¿¡æ¯ä¸­æ˜¾ç¤º `skip_fallback_reward` çŠ¶æ€**ï¼ˆç¬¬483-486è¡Œï¼‰ï¼š
   ```python
   if self.skip_fallback_reward:
       print(f"  - skip_fallback_reward: Trueï¼ˆå·²è¿‡æ»¤ fallback æ ·æœ¬ï¼Œåªä½¿ç”¨å®˜æ–¹ VQA metricï¼‰")
   else:
       print(f"  - skip_fallback_reward: Falseï¼ˆä½¿ç”¨æ‰€æœ‰æ ·æœ¬ï¼ŒåŒ…æ‹¬ fallbackï¼‰")
   ```

---

## âœ… 3.3.3 åœ¨è®­ç»ƒè„šæœ¬ä¸­æš´éœ²å¼€å…³

### ä¿®æ”¹ä½ç½®

**æ–‡ä»¶ï¼š** `lever_lm/workflows/grpo_post_train.py`

**ä¿®æ”¹å†…å®¹ï¼š**

1. **åœ¨ argparse ä¸­æ·»åŠ  `--skip_fallback_reward` å‚æ•°**ï¼ˆç¬¬532-533è¡Œï¼‰ï¼š
   ```python
   # 3.3.3: è·³è¿‡ fallback æ ·æœ¬å¼€å…³
   parser.add_argument("--skip_fallback_reward", action="store_true",
                       help="æ˜¯å¦è·³è¿‡ä½¿ç”¨ fallback æ–¹å¼è®¡ç®—çš„ RL æ ·æœ¬ï¼ˆæ¨èåœ¨ OKVQA ä¸Šæ‰“å¼€ï¼‰")
   ```

2. **åœ¨æ„é€  dataset æ—¶ä¼ å…¥å‚æ•°**ï¼ˆç¬¬642è¡Œå’Œç¬¬659è¡Œï¼‰ï¼š
   ```python
   train_dataset = RLBeamDatasetWithEmbedding(
       ...,
       skip_fallback_reward=args.skip_fallback_reward  # 3.3.3: ä¼ å…¥ skip_fallback_reward å‚æ•°
   )
   
   val_dataset = RLBeamDatasetWithEmbedding(
       ...,
       skip_fallback_reward=args.skip_fallback_reward  # 3.3.3: ä¼ å…¥ skip_fallback_reward å‚æ•°
   )
   ```

3. **åœ¨ main() å‡½æ•°ä¸­æ‰“å°çŠ¶æ€**ï¼ˆç¬¬825-828è¡Œï¼‰ï¼š
   ```python
   # 3.3.3: æ‰“å° skip_fallback_reward çŠ¶æ€
   if args.skip_fallback_reward:
       print("âœ“ å·²å¯ç”¨ skip_fallback_rewardï¼šè®­ç»ƒæ—¶å°†è·³è¿‡ fallback æ ·æœ¬ï¼Œåªä½¿ç”¨å®˜æ–¹ VQA metric")
   else:
       print("âœ“ skip_fallback_reward æœªå¯ç”¨ï¼šè®­ç»ƒæ—¶å°†ä½¿ç”¨æ‰€æœ‰æ ·æœ¬ï¼ˆåŒ…æ‹¬ fallbackï¼‰")
   ```

---

## âœ… æ›´æ–° `train_v3.sh` è„šæœ¬

### ä¿®æ”¹ä½ç½®

**æ–‡ä»¶ï¼š** `scripts/train_v3.sh`

**ä¿®æ”¹å†…å®¹ï¼š**

1. **åœ¨æ³¨é‡Šä¸­æ·»åŠ  `SKIP_FALLBACK_REWARD` ç¯å¢ƒå˜é‡è¯´æ˜**ï¼ˆç¬¬34è¡Œï¼‰ï¼š
   ```bash
   #   SKIP_FALLBACK_REWARD: è·³è¿‡ä½¿ç”¨ fallback æ–¹å¼è®¡ç®—çš„ RL æ ·æœ¬ï¼ˆé»˜è®¤: falseï¼Œæ¨èåœ¨ OKVQA ä¸Šæ‰“å¼€ï¼‰
   ```

2. **è¯»å–ç¯å¢ƒå˜é‡**ï¼ˆç¬¬158è¡Œï¼‰ï¼š
   ```bash
   skip_fallback_reward=${SKIP_FALLBACK_REWARD:-false}
   ```

3. **åœ¨é…ç½®æ‰“å°ä¸­æ˜¾ç¤ºçŠ¶æ€**ï¼ˆç¬¬194-196è¡Œï¼‰ï¼š
   ```bash
   if [ "${skip_fallback_reward}" == "true" ]; then
       echo "  Skip Fallback: è·³è¿‡ fallback æ ·æœ¬ï¼Œåªä½¿ç”¨å®˜æ–¹ VQA metric"
   fi
   ```

4. **åœ¨è®­ç»ƒå‘½ä»¤ä¸­æ·»åŠ å‚æ•°**ï¼ˆç¬¬286-289è¡Œï¼‰ï¼š
   ```bash
   # 3.3.3: å¦‚æœæŒ‡å®šè·³è¿‡ fallback æ ·æœ¬
   if [ "${skip_fallback_reward}" == "true" ]; then
       train_cmd="${train_cmd} --skip_fallback_reward"
   fi
   ```

---

## ğŸ“ ä½¿ç”¨æ–¹æ³•

### 1. ç›´æ¥ä½¿ç”¨ Python è„šæœ¬

```bash
# å¯ç”¨ skip_fallback_reward
python -m lever_lm.workflows.grpo_post_train \
    --beam_data ./results/okvqa/generated_data/rl_data_RandSampler_Qwen2_5-VL-3B-Instruct.json \
    --img_emb ./results/okvqa/cache/query_embeddings.pt \
    --output_dir ./results/okvqa/model_cpk/v3_test \
    --skip_fallback_reward \
    --device cuda:0
```

### 2. ä½¿ç”¨ `train_v3.sh` è„šæœ¬

```bash
# å¯ç”¨ skip_fallback_reward
export SKIP_FALLBACK_REWARD=true
bash scripts/train_v3.sh vqa okvqa_local 0 query_img_text_icd_img_text rand_sampler qwen2.5_vl_3B
```

---

## ğŸ¯ å®ç°æ•ˆæœ

1. **RL æ•°æ®è´¨é‡æ ‡è®°**ï¼š
   - æ¯ä¸ª pointer candidate éƒ½æœ‰ `vqa_eval_mode` å­—æ®µ
   - å¯ä»¥æ¸…æ¥šçŸ¥é“ reward çš„æ¥æºï¼ˆå®˜æ–¹ metric è¿˜æ˜¯ fallbackï¼‰

2. **è®­ç»ƒæ•°æ®è¿‡æ»¤**ï¼š
   - å¯ä»¥é€‰æ‹©åªä½¿ç”¨å®˜æ–¹ VQA metric è®¡ç®—çš„ reward
   - æé«˜è®­ç»ƒæ•°æ®çš„è´¨é‡å’Œå¯é æ€§

3. **å‘åå…¼å®¹**ï¼š
   - é»˜è®¤ä¸å¯ç”¨ `skip_fallback_reward`ï¼ˆ`False`ï¼‰
   - ä¸å½±å“ç°æœ‰è®­ç»ƒæµç¨‹
   - æ—§æ•°æ®å¦‚æœæ²¡æœ‰ `vqa_eval_mode` å­—æ®µï¼Œä¼šè¢«å½“ä½œé fallback å¤„ç†ï¼ˆ`c.get("vqa_eval_mode") == "fallback"` è¿”å› `False`ï¼‰

---

## âœ… éªŒè¯

æ‰€æœ‰ä¿®æ”¹å·²å®Œæˆï¼Œä¸”é€šè¿‡ linter æ£€æŸ¥ï¼š
- âœ… `lever_lm/models/v3/generate_rl_data.py`
- âœ… `lever_lm/models/v3/dataset_v3.py`
- âœ… `lever_lm/workflows/grpo_post_train.py`
- âœ… `scripts/train_v3.sh`

---

**ç”Ÿæˆæ—¶é—´ï¼š** 2025-12-10  
**çŠ¶æ€ï¼š** âœ… å®Œå…¨å®ç°







