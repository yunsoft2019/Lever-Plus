# v3 训练实验计划

## 实验目标

通过逐步实验，找到最佳的 v3 训练配置，或者确定 GRPO 方法是否适合这个任务。

## 当前已知结果

### 基线对比（200 条数据）
- **v2**: shot_num=1: 56.7%, shot_num=2: 56.1%, shot_num=3: 55.5%, shot_num=4: 54.7%
- **v3 优化前**（RCE=25, GRPO=25）: shot_num=1: 57.3%, shot_num=2: 50.2%, shot_num=3: 48.3%, shot_num=4: 49.6%
- **v3 优化后**（RCE=3, GRPO=8）: shot_num=1: 51.6%, shot_num=2: 48.0%, shot_num=3: 47.2%, shot_num=4: 46.0%

**结论**：优化后的参数表现更差，说明减少训练轮数不是正确的方向。

## 实验步骤

### 实验1：只使用 RCE（不进行 GRPO）

**目的**：测试 RCE 本身的效果，排除 GRPO 的影响

**配置**：
```bash
RCE_EPOCHS=10
GRPO_EPOCHS=0  # 跳过 GRPO
BATCH_SIZE=4
RCE_LR=1e-5
REWARD_ALPHA=0.5
REWARD_BETA=0.8
```

**执行**：
```bash
bash scripts/train_v3_rce_only.sh 7 rand_sampler 10
```

**预期结果**：
- 如果 RCE 效果好 → 说明问题在 GRPO
- 如果 RCE 效果也不好 → 说明问题在 RCE 或 reward 设计

---

### 实验2：增加 RCE epochs

**前提**：如果实验1显示 RCE 有效果但不够好

**配置**：
```bash
RCE_EPOCHS=15-20
GRPO_EPOCHS=0
其他参数同实验1
```

**目的**：测试是否 RCE 预热不够

---

### 实验3：RCE + 少量 GRPO

**前提**：如果实验1显示 RCE 有效果

**配置**：
```bash
RCE_EPOCHS=10
GRPO_EPOCHS=5  # 少量 GRPO
BATCH_SIZE=4
RCE_LR=1e-5
GRPO_LR=1e-5
KL_BETA=0.05  # 降低 KL beta，允许更大更新
```

**目的**：测试少量 GRPO 是否能进一步提升

---

### 实验4：调整 Reward 权重

**前提**：如果前面实验效果都不好

**配置A**：只使用 correctness
```bash
REWARD_ALPHA=0.0  # 不使用 beam_score
REWARD_BETA=1.0
```

**配置B**：增加 beam_score 权重
```bash
REWARD_ALPHA=0.8
REWARD_BETA=0.5
```

**目的**：测试 reward 设计是否合理

---

### 实验5：检查训练数据质量

**操作**：
1. 检查 `rl_data_RandSampler.json` 中 correctness=1 的比例
2. 检查 beam_score 的分布
3. 检查 reward 的分布

**目的**：确认训练数据是否有问题

---

## 实验记录模板

### 实验X：XXX

**配置**：
- RCE_EPOCHS: X
- GRPO_EPOCHS: X
- 其他参数: ...

**训练结果**：
- RCE loss: 从 X 降到 X
- Val loss: X

**推理结果**（200 条数据）：
- shot_num=1: X%
- shot_num=2: X%
- shot_num=3: X%
- shot_num=4: X%

**对比 v2**：
- shot_num=1: vs v2 (X%)
- shot_num=2: vs v2 (X%)
- ...

**结论**：
- ...

---

## 下一步行动

**立即执行：实验1 - 只使用 RCE**

```bash
conda activate lever_env
cd /mnt/share/yiyun/Projects/Lever-Plus
bash scripts/train_v3_rce_only.sh 7 rand_sampler 10
```

训练完成后，使用最佳 RCE checkpoint 进行推理：
```bash
bash scripts/inference_v3_best.sh 200 rand_sampler qwen2.5_vl_3B
```

（注意：需要修改 inference_v3_best.sh 以支持只使用 RCE checkpoint）

