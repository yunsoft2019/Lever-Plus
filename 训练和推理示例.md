# V3 训练和推理示例（基于 3.4 和 3.5.2 实现）

> 更新时间：2025-12-10  
> 基于：`README.md` 中的 v3 训练和推理脚本

---

## 1. 基础训练（RCE-only baseline，推荐）

### 使用默认参数

```bash
# 参数格式: task dataset gpu_id lever_lm sampler beam_model
bash scripts/train_v3.sh vqa okvqa_local 0 query_img_text_icd_img_text rand_sampler qwen2.5_vl_3B
```

**默认配置**：
- RCE Epochs: 5
- GRPO Epochs: 0（RCE-only baseline）
- Reward Mode: hard_plus_soft
- RCE Reward: 原始 reward (beam_rewards_raw)

**输出**：
- Checkpoint: `results/okvqa/model_cpk/v3_RandSampler_Qwen2_5-VL-3B-Instruct/rce_epoch5.pt`

---

## 2. 3.4 对比实验：使用归一化后的 reward

### 实验目的
对比 raw reward vs 归一化后的 reward 在 RCE 训练中的效果

```bash
# 使用归一化后的 reward
export RCE_USE_NORMALIZED_REWARD=true
bash scripts/train_v3.sh vqa okvqa_local 0 query_img_text_icd_img_text rand_sampler qwen2.5_vl_3B
```

**配置**：
- RCE Reward: 归一化后的 reward (beam_rewards)
- 其他参数与默认相同

**输出**：
- Checkpoint: `results/okvqa/model_cpk/v3_RandSampler_Qwen2_5-VL-3B-Instruct/rce_epoch5.pt`

---

## 3. 3.5.2 实验：GRPO 时冻结 backbone

### 实验目的
测试 GRPO 时只训练 pointer head，冻结投影层，保护 RCE-only 的成果

```bash
# GRPO 时冻结 backbone
export GRPO_EPOCHS=3 FREEZE_BACKBONE_IN_GRPO=true
bash scripts/train_v3.sh vqa okvqa_local 0 query_img_text_icd_img_text rand_sampler qwen2.5_vl_3B
```

**配置**：
- RCE Epochs: 5
- GRPO Epochs: 3
- 冻结层: input_proj, query_proj, cand_proj
- 可训练层: cross_attn_layers, attn_norms

**输出**：
- Checkpoint: `results/okvqa/model_cpk/v3_RandSampler_Qwen2_5-VL-3B-Instruct/grpo_epoch3.pt`

---

## 4. 组合实验

### RCE-only + 归一化 reward + 冻结 backbone（GRPO）

```bash
export RCE_USE_NORMALIZED_REWARD=true GRPO_EPOCHS=3 FREEZE_BACKBONE_IN_GRPO=true
bash scripts/train_v3.sh vqa okvqa_local 0 query_img_text_icd_img_text rand_sampler qwen2.5_vl_3B
```

---

## 5. 推理

### 基础推理（RCE-only baseline）

```bash
# 默认推理 100 条数据
bash scripts/inference.sh vqa okvqa_local 0 query_img_text_icd_img_text rand_sampler qwen2.5_vl_3B v3

# 推理 200 条数据
bash scripts/inference.sh vqa okvqa_local 0 query_img_text_icd_img_text rand_sampler qwen2.5_vl_3B v3 200

# 推理 400 条数据
bash scripts/inference.sh vqa okvqa_local 0 query_img_text_icd_img_text rand_sampler qwen2.5_vl_3B v3 400

# 推理 800 条数据
bash scripts/inference.sh vqa okvqa_local 0 query_img_text_icd_img_text rand_sampler qwen2.5_vl_3B v3 800

# 推理全部数据
bash scripts/inference.sh vqa okvqa_local 0 query_img_text_icd_img_text rand_sampler qwen2.5_vl_3B v3 -1
```

**说明**：
- `inference.sh` 会自动查找 v3 checkpoint（优先查找 `grpo_epoch*.pt`，如果没有则查找 `rce_epoch*.pt`）
- 如果找到 `.pt` 格式的 checkpoint，会自动转换为 `.ckpt` 格式（如果转换后的文件不存在）

---

## 6. 完整实验流程示例

### 实验 1：RCE-only baseline（默认配置）

```bash
# 训练
bash scripts/train_v3.sh vqa okvqa_local 0 query_img_text_icd_img_text rand_sampler qwen2.5_vl_3B

# 推理（100/200/400/800 条数据）
bash scripts/inference.sh vqa okvqa_local 0 query_img_text_icd_img_text rand_sampler qwen2.5_vl_3B v3 100
bash scripts/inference.sh vqa okvqa_local 0 query_img_text_icd_img_text rand_sampler qwen2.5_vl_3B v3 200
bash scripts/inference.sh vqa okvqa_local 0 query_img_text_icd_img_text rand_sampler qwen2.5_vl_3B v3 400
bash scripts/inference.sh vqa okvqa_local 0 query_img_text_icd_img_text rand_sampler qwen2.5_vl_3B v3 800
```

### 实验 2：RCE-only + 归一化 reward

```bash
# 训练
export RCE_USE_NORMALIZED_REWARD=true
bash scripts/train_v3.sh vqa okvqa_local 1 query_img_text_icd_img_text rand_sampler qwen2.5_vl_3B

# 推理
bash scripts/inference.sh vqa okvqa_local 1 query_img_text_icd_img_text rand_sampler qwen2.5_vl_3B v3 200
```

### 实验 3：RCE + GRPO（冻结 backbone）

```bash
# 训练
export GRPO_EPOCHS=3 FREEZE_BACKBONE_IN_GRPO=true
bash scripts/train_v3.sh vqa okvqa_local 2 query_img_text_icd_img_text rand_sampler qwen2.5_vl_3B

# 推理
bash scripts/inference.sh vqa okvqa_local 2 query_img_text_icd_img_text rand_sampler qwen2.5_vl_3B v3 200
```

---

## 7. 环境变量说明

| 环境变量 | 默认值 | 说明 |
|---------|--------|------|
| `RCE_EPOCHS` | 5 | RCE 预热轮数 |
| `GRPO_EPOCHS` | 0 | GRPO 训练轮数（0 = RCE-only baseline） |
| `BATCH_SIZE` | 1 | 批次大小 |
| `RCE_LR` | 1e-4 | RCE 学习率 |
| `GRPO_LR` | 5e-6 | GRPO 学习率 |
| `KL_BETA` | 0.15 | KL 散度权重 |
| `NUM_LAYERS` | 1 | Cross-Attention 层数 |
| `REWARD_MODE` | hard_plus_soft | Reward 模式 |
| `HARD_WEIGHT` | 1.0 | Hard correctness 权重 |
| `SOFT_WEIGHT` | 1.0 | Soft correctness 权重 |
| `RCE_USE_NORMALIZED_REWARD` | false | RCE 使用归一化后的 reward |
| `FREEZE_BACKBONE_IN_GRPO` | false | GRPO 时冻结 backbone |

---

## 8. 检查点文件说明

### RCE-only baseline（GRPO_EPOCHS=0）

- **文件**: `rce_epoch5.pt`
- **位置**: `results/okvqa/model_cpk/v3_RandSampler_Qwen2_5-VL-3B-Instruct/`
- **推荐**: 使用 `rce_epoch5.pt`（最后一个 RCE epoch）

### RCE + GRPO（GRPO_EPOCHS>0）

- **RCE 文件**: `rce_epoch1.pt` ~ `rce_epoch5.pt`
- **GRPO 文件**: `grpo_epoch1.pt` ~ `grpo_epoch3.pt`
- **推荐**: 使用 `grpo_epoch3.pt`（最后一个 GRPO epoch）

---

## 9. 注意事项

1. **RL 数据生成**：
   - `train_v3.sh` 会自动检查并生成 RL 数据（如果不存在）
   - 如果 RL 数据已存在，脚本会先删除旧数据再重新生成

2. **Checkpoint 转换**：
   - `inference.sh` 会自动将 `.pt` 格式转换为 `.ckpt` 格式（如果转换后的文件不存在）
   - 转换后的文件保存在同一目录，文件名格式：`rce_epoch5_v2format.ckpt`

3. **GPU 使用**：
   - 脚本会自动设置 `CUDA_VISIBLE_DEVICES=${gpu_id}`
   - 训练时使用 `--device cuda:0`（因为 `CUDA_VISIBLE_DEVICES` 会重新映射设备）

4. **实验对比**：
   - 建议使用不同的 GPU 或不同的输出目录进行对比实验
   - 记录每个实验的配置和结果，便于对比分析

---

**更新时间：** 2025-12-10

